---
import { urlFor } from '../../lib/sanity';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';
import { isSvgAsset } from '../../lib/sanity';
import {
  Heart,
  ShoppingCart,
  Factory,
  Truck,
  Landmark,
  Rocket,
  Building2,
  Briefcase,
  GraduationCap,
  Utensils,
  Plane,
  Home,
  Stethoscope,
  Package,
  BarChart3,
  Cpu,
  Leaf,
  Car,
  MoveRight,
} from '@lucide/astro';

interface Props {
  title: string;
  slug: string;
  tagline?: string;
  iconCustom?: SanityImageSource;
  iconName?: string;
  index: number;
  variant?: 'bento-featured' | 'bento' | 'stacked-full' | 'stacked';
}

const { title, slug, tagline, iconCustom, iconName, index, variant = 'bento' } = Astro.props;

// Map of Lucide icon names to components
const lucideIcons: Record<string, typeof Heart> = {
  'heart': Heart,
  'stethoscope': Stethoscope,
  'shopping-cart': ShoppingCart,
  'factory': Factory,
  'truck': Truck,
  'package': Package,
  'landmark': Landmark,
  'bar-chart-3': BarChart3,
  'rocket': Rocket,
  'building-2': Building2,
  'briefcase': Briefcase,
  'graduation-cap': GraduationCap,
  'utensils': Utensils,
  'plane': Plane,
  'home': Home,
  'cpu': Cpu,
  'leaf': Leaf,
  'car': Car,
};

/**
 * Gets the first letter of the industry title as a placeholder
 */
function getInitial(title: string | null | undefined): string {
  if (!title) return '?';
  return title.charAt(0).toUpperCase();
}

/**
 * Get custom icon URL from Sanity image
 */
function getCustomIconUrl(icon: SanityImageSource | undefined): string | null {
  if (!icon) return null;
  try {
    // Check if it's an SVG - preserve vector format
    if (isSvgAsset(icon)) {
      return urlFor(icon).url();
    }
    // For raster images, optimize
    return urlFor(icon).width(150).height(150).format('webp').url();
  } catch {
    return null;
  }
}

/**
 * Get Lucide icon component by name
 */
function getLucideIcon(name: string | undefined): typeof Heart | null {
  if (!name) return null;
  const normalized = name.toLowerCase().trim();
  return lucideIcons[normalized] || null;
}

const customIconUrl = getCustomIconUrl(iconCustom);
const LucideIcon = getLucideIcon(iconName);
---

<a
  href={`/industries/${slug}/`}
  class:list={['industry-card', variant]}
>
  <div class="industry-card__icon" aria-hidden="true">
    {customIconUrl ? (
      <img
        src={customIconUrl}
        alt=""
        width="44"
        height="44"
        loading="lazy"
      />
    ) : LucideIcon ? (
      <LucideIcon size={variant === 'bento-featured' ? 48 : 40} />
    ) : (
      <span class="industry-card__initial">{getInitial(title)}</span>
    )}
  </div>

  <div class="industry-card__content">
    <h3 class="industry-card__title">{title}</h3>
    {tagline && <p class="industry-card__tagline">{tagline}</p>}
  </div>

  <div class="industry-card__arrow" aria-hidden="true">
    <MoveRight size={18} />
  </div>
</a>

<style>
  .industry-card {
    display: block;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 28px 24px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    text-decoration: none;
    transition: border-color 0.3s ease, transform 0.3s ease;
  }

  .industry-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
  }

  .industry-card:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Icon */
  .industry-card__icon {
    color: var(--accent-dim);
    margin-bottom: 14px;
    transition: color 0.3s ease;
  }

  .industry-card:hover .industry-card__icon {
    color: var(--accent);
  }

  .industry-card__icon img {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }

  .industry-card__initial {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--text-primary);
  }

  /* Content */
  .industry-card__content {
    margin-bottom: 0;
  }

  .industry-card__title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 500;
    line-height: 1.2;
    margin-bottom: 6px;
    color: var(--text-primary);
  }

  .industry-card__tagline {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
    font-weight: 300;
  }

  /* Arrow */
  .industry-card__arrow {
    position: absolute;
    top: 24px;
    right: 24px;
    color: var(--text-muted);
    transition: all 0.3s ease;
  }

  .industry-card:hover .industry-card__arrow {
    color: var(--accent);
    transform: translateX(4px);
  }

  /* ─── Variant: Bento Featured ─── */
  .industry-card.bento-featured {
    padding: 40px 32px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .industry-card.bento-featured .industry-card__icon {
    margin-bottom: auto;
  }

  .industry-card.bento-featured .industry-card__icon img {
    width: 48px;
    height: 48px;
  }

  .industry-card.bento-featured .industry-card__title {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }

  .industry-card.bento-featured .industry-card__tagline {
    font-size: 1rem;
  }

  /* ─── Variant: Stacked Full ─── */
  .industry-card.stacked-full {
    padding: 36px 32px;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 32px;
  }

  .industry-card.stacked-full .industry-card__icon {
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .industry-card.stacked-full .industry-card__content {
    flex: 1;
  }

  .industry-card.stacked-full .industry-card__title {
    font-size: 1.5rem;
  }

  .industry-card.stacked-full .industry-card__tagline {
    max-width: 400px;
  }

  .industry-card.stacked-full .industry-card__arrow {
    position: static;
    margin-left: auto;
    flex-shrink: 0;
  }

  /* ─── Responsive ─── */
  @media (max-width: 768px) {
    .industry-card.stacked-full {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .industry-card.stacked-full .industry-card__arrow {
      position: absolute;
      top: 24px;
      right: 24px;
      margin-left: 0;
    }
  }

  /* ─── Reduced Motion ─── */
  @media (prefers-reduced-motion: reduce) {
    .industry-card,
    .industry-card__icon,
    .industry-card__arrow {
      transition: none;
    }
  }
</style>
