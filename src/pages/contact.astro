---
import BaseLayout from '../layouts/BaseLayout.astro';
import ContactHero from '../components/sections/ContactHero.astro';
import ContactFormSection from '../components/sections/ContactFormSection.astro';
import ContactMap from '../components/sections/ContactMap.astro';
import { client } from '../lib/sanity';

// Fetch site settings from Sanity for contact info
const siteSettingsQuery = `*[_type == "siteSettings"][0] {
  contactEmail,
  contactPhone,
  address,
  socialLinks {
    linkedin,
    twitter,
    instagram
  }
}`;

const siteSettings = await client.fetch<{
  contactEmail?: string;
  contactPhone?: string;
  address?: string;
  socialLinks?: {
    linkedin?: string;
    twitter?: string;
    instagram?: string;
  };
}>(siteSettingsQuery);

// Parse address into lines if provided
// If address has multiple lines, use them; otherwise use defaults
const rawAddress = siteSettings?.address?.trim();
const addressLines = rawAddress ? rawAddress.split('\n').map(line => line.trim()) : [];
const addressLine1 = addressLines[0] || "Ahmedabad, Gujarat";
// Only show addressLine2 if there are actually multiple lines, otherwise empty
const addressLine2 = addressLines.length > 1 ? addressLines[1] : (addressLines.length === 0 ? "India" : "");

// Schema.org ContactPage structured data
const contactSchema = {
  "@context": "https://schema.org",
  "@type": "ContactPage",
  "name": "Contact KP Infotech",
  "description": "Get in touch with KP Infotech to discuss your digital project. We offer UI/UX design, web development, mobile apps, and ERP solutions.",
  "url": "https://kpinfo.tech/contact/",
  "mainEntity": {
    "@type": "Organization",
    "name": "KP Infotech",
    "email": siteSettings?.contactEmail || "info@kpinfo.tech",
    "telephone": siteSettings?.contactPhone || "+91 86182 79004",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Ahmedabad",
      "addressRegion": "Gujarat",
      "addressCountry": "India"
    }
  }
};
---

<BaseLayout
  title="Contact"
  description="Get in touch with KP Infotech to discuss your digital project. We craft exceptional UI/UX designs, web applications, mobile apps, and enterprise solutions."
>
  <!-- Schema.org structured data -->
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(contactSchema)} />
  </Fragment>

  <ContactHero
    label="Get In Touch"
    headline="Let's Build Something *Great*"
    description="We're ready to bring your vision to life. Tell us about your project and let's create something extraordinary together."
  />

  <ContactFormSection
    email={siteSettings?.contactEmail || "info@kpinfo.tech"}
    phone={siteSettings?.contactPhone || "+91 86182 79004"}
    address={addressLine1}
    addressLine2={addressLine2}
    officeHours="Mon – Fri: 9AM – 6PM IST"
    officeHoursSaturday="Sat: 10AM – 2PM IST"
    socialLinks={siteSettings?.socialLinks}
  />

  <ContactMap
    title="Visit Our Office"
    companyName="KP Infotech"
    address={addressLine1}
    country={addressLine2}
    socialLinks={siteSettings?.socialLinks}
  />
</BaseLayout>

<script>
  // Form handling with client-side validation and future HubSpot integration
  const form = document.getElementById('contact-form') as HTMLFormElement;

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitButton = form.querySelector('.form-submit') as HTMLButtonElement;
      const originalText = submitButton.querySelector('.form-submit__text')?.textContent;

      // Update button state
      submitButton.disabled = true;
      const textSpan = submitButton.querySelector('.form-submit__text');
      if (textSpan) textSpan.textContent = 'Sending...';

      // Collect form data
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        // For now, log the data - replace with HubSpot API integration
        console.log('Form submitted:', data);

        // TODO: HubSpot Forms API integration
        // const response = await fetch(
        //   `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formId}`,
        //   {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({
        //       fields: [
        //         { name: 'firstname', value: data.name },
        //         { name: 'email', value: data.email },
        //         { name: 'company', value: data.company || '' },
        //         { name: 'phone', value: data.phone || '' },
        //         { name: 'project_type', value: data.project_type || '' },
        //         { name: 'budget', value: data.budget || '' },
        //         { name: 'message', value: data.message },
        //       ],
        //     }),
        //   }
        // );

        // Simulate success
        if (textSpan) textSpan.textContent = 'Message Sent!';
        form.reset();

        // Reset button after delay
        setTimeout(() => {
          if (textSpan) textSpan.textContent = originalText || 'Send Message';
          submitButton.disabled = false;
        }, 3000);

      } catch (error) {
        console.error('Form submission error:', error);
        if (textSpan) textSpan.textContent = 'Error - Try Again';
        submitButton.disabled = false;

        setTimeout(() => {
          if (textSpan) textSpan.textContent = originalText || 'Send Message';
        }, 3000);
      }
    });
  }
</script>
